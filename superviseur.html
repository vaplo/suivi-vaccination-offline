<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>FlowLab ‚Äì Espace Superviseur</title>
  <link rel="stylesheet" href="styles.css" />
  <link rel="manifest" href="manifest.webmanifest" />

  <!-- jsPDF + autoTable (CDN) : n√©cessaire pour exporter en PDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
  <!-- Chart.js pour le graphique -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>

  <!-- Favicon -->
  <link rel="icon" type="image/png" href="images/logo.png">
  <meta name="theme-color" content="#16a085" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-capable" content="yes" />

  <style>
    body { font-family:'Segoe UI', sans-serif; background-color:#f4fdfc; margin:0; color:#333; }
    .top-bar { background-color:#16a085; color:white; text-align:center; padding:1rem; border-bottom:4px solid #138d75; }
    .top-bar .logo { display:block; margin:0 auto .5rem; max-height:60px; }
    .grid-cards { display:grid; grid-template-columns:repeat(auto-fit,minmax(280px,1fr)); gap:1.5rem; padding:2rem; }
    .card { position:relative; background-size:cover; background-position:center; border-radius:16px; min-height:280px;
            display:flex; flex-direction:column; justify-content:flex-end; overflow:hidden; box-shadow:0 4px 12px rgba(0,0,0,.15); padding:1.5rem; color:white; }
    .card::before { content:""; position:absolute; inset:0; background:rgba(0,0,0,.5); z-index:0; }
    .card * { position:relative; z-index:1; }
    .card h3 { margin-bottom:.5rem; }
    .btn { margin-top:1rem; padding:.6rem 1rem; background-color:#16a085; color:white; border:none; border-radius:8px; text-decoration:none; font-weight:bold; cursor:pointer; }
    .btn:hover { background-color:#138d75; }
    .btn-secondary { background-color:#2980b9; }
    .btn-secondary:hover { background-color:#216a94; }
    .btn-small { padding:.45rem .7rem; font-size:.9rem; border-radius:6px; }
    .container { max-width:1000px; margin:0 auto; }
    .formulaire { background:#fff; border-radius:12px; padding:1.5rem; margin:1rem 2rem; box-shadow:0 2px 6px rgba(0,0,0,.1); display:none; }
    .table-stats { width:100%; border-collapse:collapse; margin-top:1rem; }
    .table-stats th, .table-stats td { border:1px solid #ccc; padding:.75rem; text-align:left; }
    .table-stats th { background-color:#16a085; color:white; }
    @media (max-width:600px){ .card{padding:1rem;} }
  </style>

  <script>
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("service-worker.js")
        .then(() => console.log("‚úÖ SW actif"))
        .catch(err => console.error("‚ùå SW error:", err));
    }
  </script>
</head>

<body>
  <header class="top-bar">
    <img src="images/logo.png" alt="FlowLab Logo" class="logo" />
    <h1>FlowLab</h1>
    <h2>Syst√®me intelligent d‚Äôimpl√©mentation de la vaccination en RDC</h2>
    <p>Supervision & Retards</p>
  </header>

  <main class="container">
    <section class="grid-cards">
      <div class="card" style="background-image: url('images/suiviequitable.png')">
        <h3>üìä Suivi √©quitable</h3>
        <p>Identifiez les in√©galit√©s de vaccination entre les structures et r√©gions.</p>
        <button class="btn" onclick="afficherTableau('equite')">üìà Voir Suivi</button>
      </div>

      <div class="card" style="background-image: url('images/exportdesretards.png')">
        <h3>üìÇ Export des retards</h3>
        <p>T√©l√©chargez les listes des enfants en retard pour traitement et suivi.</p>
        <button class="btn btn-secondary" onclick="afficherTableau('retards'); telechargerRetards()">üì• Exporter</button>
      </div>

      <div class="card" style="background-image: url('images/surveillancesoin.png')">
        <h3>ü©∫ Surveillance des soins</h3>
        <p>V√©rifiez la couverture vaccinale et la qualit√© des soins par √©tablissement.</p>
        <button class="btn" onclick="afficherTableau('soins')">üîç Voir Soins</button>
      </div>
    </section>

    <!-- Suivi √©quitable -->
    <section class="formulaire" id="equite">
      <h3>üìä Tableau de Suivi √âquitable</h3>
      <table class="table-stats">
        <thead>
          <tr>
            <th>Structure</th>
            <th>Total Enfants</th>
            <th>Total Femmes</th>
            <th>Total Vaccins Pr√©vus</th>
            <th>Total Vaccins Faits</th>
          </tr>
        </thead>
        <tbody id="table-equite">
          <tr><td colspan="5">Chargement...</td></tr>
        </tbody>
      </table>
    </section>

    <!-- Retards -->
    <section class="formulaire" id="retards">
      <div style="display:flex; align-items:center; justify-content:space-between; gap:.5rem;">
        <h3 style="margin:0;">üìÇ Enfants en Retard de Vaccination</h3>
        <div style="display:flex; gap:.5rem; align-items:center;">
          <button id="export-csv" class="btn btn-small">Export CSV</button>
          <button id="export-txt" class="btn btn-small btn-secondary">Export TXT</button>
          <button id="export-pdf" class="btn btn-small" style="background-color:black;">Export PDF</button>
        </div>
      </div>
      <p> T√©l√©chargez les listes des enfants en retard pour traitement et suivi.</p>

      <table class="table-stats">
        <thead>
          <tr>
            <th>Nom</th><th>Date naissance</th><th>Vaccin</th><th>Dose</th>
            <th>Date Prevue</th><th>Admin</th><th>Statut</th><th>Centre</th><th>Tel Parents</th>
          </tr>
        </thead>
        <tbody id="table-retards">
          <tr><td colspan="9">Chargement...</td></tr>
        </tbody>
      </table>
    </section>

    <!-- Surveillance des Soins -->
    <section class="formulaire" id="soins">
      <h3>ü©∫ Surveillance des Soins par Structure</h3>

      <!-- Graphique -->
      <div class="panel" style="background:#fff;border-radius:12px;padding:1rem;box-shadow:0 2px 6px rgba(0,0,0,.1); margin-bottom:1rem; height:320px;">
        <canvas id="chart-soins"></canvas>
      </div>

      <table class="table-stats">
        <thead>
          <tr>
            <th>Structure</th>
            <th>DTC_HepB_Hib_1</th>
            <th>DTC_HepB_Hib_3</th>
            <th>Abandon P1‚ÜíP3 (%)</th>
            <th>Retards 30j+ (Enfants)</th>
            <th>VAT1 (mois)</th>
            <th>VAT2 (mois)</th>
            <th>Retards 30j+ (Pr√©natal)</th>
            <th>Priorit√©</th>
          </tr>
        </thead>
        <tbody id="table-soins">
          <tr><td colspan="9">Chargement...</td></tr>
        </tbody>
      </table>
    </section>

    <footer>
      <a href="index.html" class="btn">‚¨Ö Retour √† l'accueil</a>
    </footer>
  </main>

  <script>
    const webhookRetards = "https://n8n-automation-server-waz-production.up.railway.app/webhook-test/export-retards";

    function telechargerRetards() {
      fetch(webhookRetards)
        .then(response => response.blob())
        .then(blob => {
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = "retards_vaccination.xlsx";
          document.body.appendChild(a);
          a.click();
          a.remove();
        });
    }

    function afficherTableau(id) {
      const section = document.getElementById(id);
      if (section) {
        section.style.display = 'block';
        section.scrollIntoView({ behavior: 'smooth' });
      }
    }

    // === Suivi √©quitable ===
    fetch("https://n8n-automation-server-waz-production.up.railway.app/webhook-test/suivi-equitable", { headers: { "Accept": "application/json" }})
      .then(r => r.json())
      .then(data => {
        const rows = data.map(e => `
          <tr>
            <td>${e.centre_sante}</td>
            <td>${e.total_enfants}</td>
            <td>${e.total_femmes}</td>
            <td>${e.total_vaccins_prevus}</td>
            <td>${e.total_vaccins_faits}</td>
          </tr>
        `).join("");
        document.getElementById("table-equite").innerHTML = rows || `<tr><td colspan="5">Aucun r√©sultat</td></tr>`;
      })
      .catch(err => {
        console.error(err);
        document.getElementById("table-equite").innerHTML = `<tr><td colspan="5">Erreur de chargement</td></tr>`;
      });

    // === Retards ===
    fetch("https://n8n-automation-server-waz-production.up.railway.app/webhook-test/export-retards")
      .then(r => r.json())
      .then(data => {
        const rows = data.map(e => `
          <tr>
            <td>${e.nom_complet}</td>
            <td>${e.date_naissance}</td>
            <td>${e.vaccin}</td>
            <td>${e.dose}</td>
            <td>${e.date_prevue}</td>
            <td>${e.date_administration ?? ''}</td>
            <td>${e.statut ?? ''}</td>
            <td>${e.centre_sante ?? ''}</td>
            <td>${e.telephone_parent ?? ''}</td>
          </tr>
        `).join("");
        document.getElementById("table-retards").innerHTML = rows || `<tr><td colspan="9">Aucun r√©sultat</td></tr>`;
      })
      .catch(err => {
        console.error(err);
        document.getElementById("table-retards").innerHTML = `<tr><td colspan="9">Erreur de chargement</td></tr>`;
      });

    // === Surveillance des Soins (table + graphique) ===
    let chartSoins;
    async function loadSurveillanceSoins() {
      try {
        const r = await fetch("https://n8n-automation-server-waz-production.up.railway.app/webhook-test/surveillance-soins", {
          headers: { "Accept": "application/json" }
        });
        const data = await r.json();

        // TABLE
        const rows = (Array.isArray(data) ? data : []).map(e => `
          <tr>
            <td>${e.centre_sante ?? ''}</td>
            <td>${e.dtc_hib1 ?? 0}</td>
            <td>${e.dtc_hib3 ?? 0}</td>
            <td>${e.abandon_p1_p3_pct ?? 0}</td>
            <td>${e.retards_30j_plus_enfants ?? 0}</td>
            <td>${e.tt1_rdv_mois ?? 0}</td>
            <td>${e.tt2_rdv_mois ?? 0}</td>
            <td>${e.retards_30j_plus_prenatal ?? 0}</td>
            <td>${e.priorite ?? ''}</td>
          </tr>
        `).join("");
        document.getElementById("table-soins").innerHTML = rows || `<tr><td colspan="9">Aucun r√©sultat</td></tr>`;

        // GRAPH (barres : Penta1 vs Penta3, + ligne : % Abandon)
        const labels  = data.map(x => x.centre_sante);
        const p1      = data.map(x => Number(x.dtc_hib1 || 0));
        const p3      = data.map(x => Number(x.dtc_hib3 || 0));
        const abandon = data.map(x => Number(x.abandon_p1_p3_pct || 0));

        const ctx = document.getElementById('chart-soins').getContext('2d');
        if (chartSoins) chartSoins.destroy();
        chartSoins = new Chart(ctx, {
          type: 'bar',
          data: {
            labels,
            datasets: [
              { label: 'DTC_HepB_Hib_1', data: p1, yAxisID: 'y' },
              { label: 'DTC_HepB_Hib_3', data: p3, yAxisID: 'y' },
              { label: 'Abandon P1‚ÜíP3 (%)', data: abandon, type: 'line', yAxisID: 'y1' }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: true },
              tooltip: {
                callbacks: {
                  afterLabel: (ctx) => {
                    const i = ctx.dataIndex;
                    const r30e = data[i]?.retards_30j_plus_enfants ?? 0;
                    const r30p = data[i]?.retards_30j_plus_prenatal ?? 0;
                    const prio = data[i]?.priorite ?? '';
                    return `\nRetards 30j+ (Enf): ${r30e}\nRetards 30j+ (Pr√©n): ${r30p}\nPriorit√©: ${prio}`;
                  }
                }
              }
            },
            scales: {
              y:  { beginAtZero:true, title:{ display:true, text:'Nombre de doses' } },
              y1: { beginAtZero:true, position:'right', title:{ display:true, text:'% Abandon' } }
            }
          }
        });
      } catch (err) {
        console.error('Surveillance des soins error:', err);
        document.getElementById("table-soins").innerHTML = `<tr><td colspan="9">Erreur de chargement</td></tr>`;
      }
    }

    // Auto-load
    window.addEventListener('load', () => {
      loadSurveillanceSoins().catch(console.error);
    });

    // === Utils export ===
    function readTable(tableId) {
      const table = document.getElementById(tableId);
      if (!table) return null;
      const headers = Array.from(table.querySelectorAll('thead th')).map(th => th.textContent.trim());
      const rows = Array.from(table.querySelectorAll('tbody tr')).map(tr =>
        Array.from(tr.querySelectorAll('td')).map(td => td.textContent.trim())
      );
      return { headers, rows };
    }

    function exportTableToCSV(tableId, filename='table.csv') {
      const data = readTable(tableId);
      if (!data) { alert('Table introuvable'); return; }
      const lines = [];
      lines.push(data.headers.map(h => `"${h.replace(/"/g,'""')}"`).join(','));
      data.rows.forEach(r => lines.push(r.map(cell => `"${String(cell).replace(/"/g,'""')}"`).join(',')));
      const csv = lines.join('\r\n');
      const blob = new Blob([csv], { type:'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = filename;
      document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    }

    function exportTableToTXT(tableId, filename='table.txt') {
      const data = readTable(tableId);
      if (!data) { alert('Table introuvable'); return; }
      const lines = [];
      lines.push(data.headers.join('\t'));
      data.rows.forEach(r => lines.push(r.join('\t')));
      const txt = lines.join('\r\n');
      const blob = new Blob([txt], { type:'text/plain;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = filename;
      document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    }

    async function exportTableToPDF(tableId, filename='table.pdf') {
      const data = readTable(tableId);
      if (!data) { alert('Table introuvable'); return; }
      const { jsPDF } = window.jspdf || (window.jspdf = window.jspdf || {});
      if (!jsPDF) { alert('jsPDF non charg√©.'); return; }
      const doc = new jsPDF({ unit:'pt', format:'a4' });
      const head = [data.headers]; const body = data.rows;
      doc.setFontSize(14); doc.text('Retards de vaccination', 40, 40);
      doc.autoTable({ startY:60, head, body, styles:{ fontSize:10 }, headStyles:{ fillColor:[22,160,133], textColor:255 }, margin:{ left:40, right:40 } });
      doc.save(filename);
    }

    document.getElementById('export-csv')?.addEventListener('click', () => exportTableToCSV('table-retards', 'retards_vaccination.csv'));
    document.getElementById('export-txt')?.addEventListener('click', () => exportTableToTXT('table-retards', 'retards_vaccination.txt'));
    document.getElementById('export-pdf')?.addEventListener('click', () => exportTableToPDF('table-retards', 'retards_vaccination.pdf'));
  </script>
</body>
</html>




