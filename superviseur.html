<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>FlowLab ‚Äì Espace Superviseur</title>

  <!-- SEO -->
  <meta name="description" content="Suivi √©quitable, export des retards et surveillance des soins ‚Äî FlowLab, supervision vaccination RDC.">
  <link rel="manifest" href="manifest.webmanifest" />
  <meta name="theme-color" content="#16a085" />

  <!-- PWA -->
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-capable" content="yes" />

  <!-- Open Graph -->
  <meta property="og:title" content="FlowLab ‚Äì Espace Superviseur">
  <meta property="og:description" content="Vos tableaux de supervision vaccination : √©quit√©, retards, soins.">
  <meta property="og:image" content="images/og-flowlab.png">
  <meta property="og:type" content="website">

  <!-- Styles -->
  <link rel="stylesheet" href="styles.css" />
  <style>
    :root { --primary:#16a085; --primary-dark:#138d75; --blue:#2980b9; --blue-dark:#216a94; }
    * { box-sizing: border-box; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background:#f4fdfc; margin:0; color:#333; }
    a { color: inherit; }

    .skip-link { position:absolute; left:-9999px; top:auto; width:1px; height:1px; overflow:hidden; }
    .skip-link:focus { position:static; width:auto; height:auto; padding:0.5rem; background:#000; color:#fff; }

    .top-bar { background:var(--primary); color:#fff; text-align:center; padding:1rem; border-bottom:4px solid var(--primary-dark); }
    .top-bar .logo { display:block; margin:0 auto 0.5rem; max-height:60px; }
    .top-bar h1 { margin:.2rem 0 .1rem; font-size:1.6rem; }
    .top-bar h2 { margin:.1rem 0 .5rem; font-weight:500; font-size:1rem; opacity:.95; }
    .top-bar p  { margin:0; opacity:.9; }

    .container { max-width:1100px; margin:0 auto; padding:0 1rem 2rem; }

    .grid-cards {
      display:grid; grid-template-columns:repeat(auto-fit, minmax(280px,1fr));
      gap:1.5rem; padding:2rem 0 0;
    }
    .card {
      position:relative; background-size:cover; background-position:center;
      border-radius:16px; min-height:280px; display:flex; flex-direction:column; justify-content:flex-end;
      overflow:hidden; box-shadow:0 4px 12px rgba(0,0,0,.15); padding:1.5rem; color:#fff;
    }
    .card::before { content:""; position:absolute; inset:0; background:rgba(0,0,0,.5); z-index:0; }
    .card * { position:relative; z-index:1; }
    .card h3 { margin:0 0 .5rem; }

    .btn { margin-top:1rem; padding:.6rem 1rem; background:var(--primary); color:#fff; border:none; border-radius:8px; font-weight:700; cursor:pointer; }
    .btn:hover { background:var(--primary-dark); }
    .btn-secondary { background:var(--blue); }
    .btn-secondary:hover { background:var(--blue-dark); }

    .formulaire {
      background:#fff; border-radius:12px; padding:1.5rem; margin:1.5rem 0 0;
      box-shadow:0 2px 6px rgba(0,0,0,.08); display:none;
    }

    .table-stats { width:100%; border-collapse:collapse; margin-top:1rem; }
    .table-stats th, .table-stats td { border:1px solid #ccc; padding:.75rem; text-align:left; }
    .table-stats th { background:var(--primary); color:#fff; }
    .visually-hidden { position:absolute !important; clip:rect(1px,1px,1px,1px); padding:0 !important; border:0 !important; height:1px !important; width:1px !important; overflow:hidden; }

    footer { text-align:center; margin:2rem 0; }
    @media (max-width:600px){ .card{ padding:1rem; } }
  </style>

  <script>
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("service-worker.js")
        .then(() => console.log("‚úÖ Service Worker actif"))
        .catch(err => console.error("‚ùå SW error:", err));
    }
  </script>
</head>
<body>
  <a class="skip-link" href="#main">Aller au contenu</a>
  <header class="top-bar" role="banner">
    <img src="images/logo.png" alt="Logo FlowLab" class="logo" />
    <h1>FlowLab</h1>
    <h2>Syst√®me intelligent d‚Äôimpl√©mentation de la vaccination en RDC</h2>
    <p>Supervision &amp; Retards</p>
  </header>

  <main id="main" class="container">
    <section class="grid-cards" aria-label="Actions rapides">
      <div class="card" style="background-image:url('images/suiviequitable.png')">
        <h3>üìä Suivi √©quitable</h3>
        <p>Identifiez les in√©galit√©s de vaccination entre les structures et r√©gions.</p>
        <button class="btn" aria-controls="equite" onclick="afficherTableau('equite')">üìà Voir Suivi</button>
      </div>
      <div class="card" style="background-image:url('images/exportdesretards.png')">
        <h3>üìÇ Export des retards</h3>
        <p>T√©l√©chargez les listes des enfants en retard pour traitement et suivi.</p>
        <button class="btn btn-secondary" aria-controls="retards" onclick="afficherTableau('retards'); telechargerRetards()">üì• Exporter</button>
      </div>
      <div class="card" style="background-image:url('images/surveillancesoin.png')">
        <h3>ü©∫ Surveillance des soins</h3>
        <p>V√©rifiez la couverture vaccinale et la qualit√© des soins par √©tablissement.</p>
        <button class="btn" aria-controls="soins" onclick="afficherTableau('soins')">üîç Voir Soins</button>
      </div>
    </section>

    <!-- Suivi √©quitable -->
    <section class="formulaire" id="equite" role="region" aria-labelledby="equite-title">
      <h2 id="equite-title">üìä Tableau de Suivi √âquitable</h2>
      <div aria-live="polite" class="visually-hidden" id="equite-status">Chargement‚Ä¶</div>
      <table class="table-stats">
        <caption class="visually-hidden">Comparaison par structure : enfants, vaccins pr√©vus, vaccins faits</caption>
        <thead>
          <tr>
            <th scope="col">Structure</th>
            <th scope="col">Total Enfants</th>
            <th scope="col">Total Vaccins Pr√©vus</th>
            <th scope="col">Taux de couverture</th>
          </tr>
        </thead>
        <tbody id="table-equite">
          <tr><td colspan="4">Chargement...</td></tr>
        </tbody>
      </table>
    </section>

    <!-- Retards -->
    <section class="formulaire" id="retards" role="region" aria-labelledby="retards-title">
      <h2 id="retards-title">üìÇ Enfants en Retard de Vaccination</h2>
      <div aria-live="polite" class="visually-hidden" id="retards-status">Chargement‚Ä¶</div>
      <table class="table-stats">
        <caption class="visually-hidden">Liste d√©taill√©e des retards</caption>
        <thead>
          <tr>
            <th scope="col">Nom</th><th scope="col">Date naissance</th><th scope="col">Vaccin</th>
            <th scope="col">Dose</th><th scope="col">Date pr√©vue</th><th scope="col">Admin</th>
            <th scope="col">Statut</th><th scope="col">Centre</th><th scope="col">Tel Parents</th>
          </tr>
        </thead>
        <tbody id="table-retards">
          <tr><td colspan="9">Chargement...</td></tr>
        </tbody>
      </table>
    </section>

    <!-- Surveillance des soins -->
    <section class="formulaire" id="soins" role="region" aria-labelledby="soins-title">
      <h2 id="soins-title">ü©∫ Surveillance des Soins par Structure</h2>
      <div aria-live="polite" class="visually-hidden" id="soins-status">Chargement‚Ä¶</div>
      <table class="table-stats">
        <caption class="visually-hidden">Synth√®se par structure : enfants, vaccins effectu√©s, femmes, soins pr√©natals</caption>
        <thead>
          <tr>
            <th scope="col">Structure</th>
            <th scope="col">Total Enfants</th>
            <th scope="col">Vaccins effectu√©s</th>
            <th scope="col">Total Femmes</th>
            <th scope="col">Soins pr√©natals</th>
          </tr>
        </thead>
        <tbody id="table-soins">
          <tr><td colspan="5">Chargement...</td></tr>
        </tbody>
      </table>
    </section>

    <footer>
      <a href="index.html" class="btn">‚¨Ö Retour √† l'accueil</a>
    </footer>
  </main>

  <script>
    // ====== Endpoints centralis√©s
    const BASE = "https://n8n-automation-server-waz-production.up.railway.app";
    const webhookEquite   = `${BASE}/webhook-test/suivi-equitable`;
    const webhookRetards  = `${BASE}/webhook-test/export-retards`;        // JSON
    const webhookRetardsX = `${BASE}/webhook-test/export-retards-file`;   // XLSX (binaire)
    const webhookSoins    = `${BASE}/webhook-test/surveillance-soins`;

    function afficherTableau(id) {
      for (const sec of document.querySelectorAll(".formulaire")) sec.style.display = "none";
      const section = document.getElementById(id);
      if (section) { section.style.display = "block"; section.scrollIntoView({ behavior: "smooth" }); }
    }

    // ====== Chargement √âquit√©
    async function loadEquite() {
      const el = document.getElementById("table-equite");
      try {
        const r = await fetch(webhookEquite, { headers: { Accept: "application/json" }});
        const data = await r.json();
        const rows = (Array.isArray(data) ? data : []).map(e => {
          const faits = Number(e.total_vaccins_faits ?? 0);
          const prevu = Number(e.total_vaccins_prevus ?? 0);
          const taux  = e.taux_couverture ?? Math.round((faits / Math.max(prevu,1)) * 100);
          return `<tr>
            <td>${e.centre_sante ?? ""}</td>
            <td>${e.total_enfants ?? 0}</td>
            <td>${prevu}</td>
            <td>${taux}%</td>
          </tr>`;
        }).join("");
        el.innerHTML = rows || `<tr><td colspan="4">Aucune donn√©e</td></tr>`;
      } catch {
        el.innerHTML = `<tr><td colspan="4">Erreur de chargement</td></tr>`;
      }
    }

    // ====== Chargement Retards (table)
    async function loadRetards() {
      const el = document.getElementById("table-retards");
      try {
        const r = await fetch(webhookRetards, { headers: { Accept: "application/json" }});
        const data = await r.json();
        const rows = (Array.isArray(data) ? data : []).map(e => `
          <tr>
            <td>${e.nom_complet ?? ""}</td>
            <td>${e.date_naissance ?? ""}</td>
            <td>${e.vaccin ?? ""}</td>
            <td>${e.dose ?? ""}</td>
            <td>${e.date_prevue ?? ""}</td>
            <td>${e.date_administration ?? ""}</td>
            <td>${e.statut ?? ""}</td>
            <td>${e.centre_sante ?? ""}</td>
            <td>${e.telephone_parent ?? ""}</td>
          </tr>
        `).join("");
        el.innerHTML = rows || `<tr><td colspan="9">Aucune donn√©e</td></tr>`;
      } catch {
        el.innerHTML = `<tr><td colspan="9">Erreur de chargement</td></tr>`;
      }
    }

    // ====== Chargement Soins
    async function loadSoins() {
      const el = document.getElementById("table-soins");
      try {
        const r = await fetch(webhookSoins, { headers: { Accept: "application/json" }});
        const data = await r.json();
        const rows = (Array.isArray(data) ? data : []).map(e => `
          <tr>
            <td>${e.centre_sante ?? ""}</td>
            <td>${e.total_enfants ?? 0}</td>
            <td>${e.total_vaccins_administres ?? 0}</td>
            <td>${e.total_femmes ?? 0}</td>
            <td>${e.soins_prenatals ?? 0}</td>
          </tr>
        `).join("");
        el.innerHTML = rows || `<tr><td colspan="5">Aucune donn√©e</td></tr>`;
      } catch {
        el.innerHTML = `<tr><td colspan="5">Erreur de chargement</td></tr>`;
      }
    }

    // ====== Export : essaie l'XLSX, sinon fallback CSV depuis JSON
    async function telechargerRetards() {
      try {
        // 1) Tentative binaire XLSX
        const rx = await fetch(webhookRetardsX);
        const ct = rx.headers.get("Content-Type") || "";
        if (rx.ok && ct.includes("application/vnd.openxmlformats-officedocument.spreadsheetml.sheet")) {
          const blob = await rx.blob();
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url; a.download = "retards_vaccination.xlsx";
          document.body.appendChild(a); a.click(); a.remove(); return;
        }
        // 2) Fallback CSV via JSON
        const r = await fetch(webhookRetards, { headers: { Accept: "application/json" } });
        const data = await r.json();
        const headers = ["nom_complet","date_naissance","vaccin","dose","date_prevue","date_administration","statut","centre_sante","telephone_parent"];
        const csv = [headers.join(",")].concat(
          (Array.isArray(data) ? data : []).map(e => headers.map(h => (String(e[h] ?? "").replaceAll('"','""'))).map(x=>`"${x}"`).join(","))
        ).join("\n");
        const blob = new Blob([csv], { type:"text/csv;charset=utf-8" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url; a.download = "retards_vaccination.csv";
        document.body.appendChild(a); a.click(); a.remove();
      } catch {
        alert("Export indisponible pour le moment.");
      }
    }

    // Init
    (function init(){ loadEquite(); loadRetards(); loadSoins(); })();
  </script>
</body>
</html>




