<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>FlowLab – Supervision</title>
  <link rel="stylesheet" href="styles.css" />
  <link rel="manifest" href="manifest.webmanifest" />
  <meta name="theme-color" content="#16a085" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <script>
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("service-worker.js")
        .then(() => console.log("✅ SW actif"))
        .catch(err => console.error("❌ SW error:", err));
    }
  </script>
</head>
<body>
  <header class="top-bar">
    <h1>📊 Espace Superviseur – FlowLab</h1>
    <p>Suivi des performances par structure de santé</p>
  </header>

  <main class="container">
    <section id="stats">
      <h2>📈 Statistiques globales</h2>
      <p>Total enfants enregistrés : <strong id="total-enfants">...</strong></p>
      <p>Vaccins prévus aujourd’hui : <strong id="vaccins-aujourdhui">...</strong></p>
      <p>Vaccins en retard : <strong id="vaccins-retard">...</strong></p>
    </section>

    <section>
      <button onclick="synchroniserDonnees()" class="btn btn-primary">🔄 Synchroniser</button>
      <button onclick="exporterCSV()" class="btn btn-secondary">⬇️ Exporter CSV</button>
      <button onclick="logout()" class="btn btn-danger">🚪 Déconnexion</button>
    </section>

    <section>
      <h2>⚠️ Enfants en retard de vaccination</h2>
      <label>Filtrer par structure de santé :
        <select id="filtre-centre">
          <option value="">Toutes</option>
        </select>
      </label>

      <table id="table-retards">
        <thead>
          <tr>
            <th>Nom</th>
            <th>Structure</th>
            <th>Vaccin</th>
            <th>Date prévue</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>
  </main>

  <script>
    const webhookStats = "https://n8n-automation-server-waz-production.up.railway.app/webhook-test/stats-superviseur";

    // Charger les statistiques au démarrage
    fetch(webhookStats)
      .then(res => res.json())
      .then(data => {
        document.getElementById("total-enfants").textContent = data.total_enfants || 0;
        document.getElementById("vaccins-aujourdhui").textContent = data.vaccins_aujourdhui || 0;
        document.getElementById("vaccins-retard").textContent = data.vaccins_retard || 0;

        const centres = new Set();
        const tbody = document.querySelector("#table-retards tbody");
        tbody.innerHTML = "";

        data.enfants_retard?.forEach(enfant => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${enfant.nom}</td>
            <td>${enfant.centre_sante}</td>
            <td>${enfant.vaccin}</td>
            <td>${enfant.date_prevue}</td>
          `;
          tbody.appendChild(tr);
          centres.add(enfant.centre_sante);
        });

        const select = document.getElementById("filtre-centre");
        centres.forEach(cs => {
          const opt = document.createElement("option");
          opt.value = cs;
          opt.textContent = cs;
          select.appendChild(opt);
        });

        select.addEventListener("change", () => {
          const filtre = select.value;
          Array.from(tbody.children).forEach(tr => {
            const centre = tr.children[1].textContent;
            tr.style.display = (filtre === "" || filtre === centre) ? "table-row" : "none";
          });
        });
      });

    function exporterCSV() {
      let rows = [["Nom", "Structure", "Vaccin", "Date prévue"]];
      document.querySelectorAll("#table-retards tbody tr").forEach(tr => {
        const cells = Array.from(tr.children).map(td => td.textContent);
        rows.push(cells);
      });
      const csvContent = "data:text/csv;charset=utf-8," + rows.map(e => e.join(",")).join("\n");
      const link = document.createElement("a");
      link.setAttribute("href", encodeURI(csvContent));
      link.setAttribute("download", "retards_vaccination.csv");
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    function logout() {
      localStorage.removeItem("session_token");
      localStorage.removeItem("user_role");
      localStorage.removeItem("username");
      window.location.href = "login.html";
    }

    function synchroniserDonnees() {
      location.reload(); // simple pour ce cas
    }
  </script>
</body>
</html>




