<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>FlowLab ‚Äì Espace M√©dical Infirmi√®re</title>
  <link rel="manifest" href="manifest.webmanifest" />
  <meta name="theme-color" content="#16a085" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background-color: #f4fdfc;
      margin: 0;
      color: #333;
    }

    .top-bar {
      background-color: #16a085;
      color: white;
      text-align: center;
      padding: 1rem;
      border-bottom: 4px solid #138d75;
    }

    .top-bar .logo {
      display: block;
      margin: 0 auto 0.5rem;
      max-height: 60px;
    }

    .grid-cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 1.5rem;
      padding: 2rem;
    }

    .card {
      position: relative;
      background-size: cover;
      background-position: center;
      border-radius: 16px;
      min-height: 280px;
      display: flex;
      flex-direction: column;
      justify-content: flex-end;
      overflow: hidden;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      padding: 1.5rem;
      color: white;
    }

    .card::before {
      content: "";
      position: absolute;
      inset: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 0;
    }

    .card * {
      position: relative;
      z-index: 1;
    }

    .card h3 {
      margin-bottom: 0.5rem;
    }

    .btn-small { padding: .35rem .6rem; font-size: .875rem; border-radius: 6px; }
    .btn-inline { margin: 0; display: inline-flex; align-items: center; gap: .4rem; }
    .btn[disabled] { opacity: .6; cursor: not-allowed; }


    .btn {
      margin-top: 1rem;
      padding: 0.6rem 1rem;
      background-color: #16a085;
      color: white;
      border: none;
      border-radius: 8px;
      text-decoration: none;
      font-weight: bold;
      cursor: pointer;
      display: inline-block;
      text-align: center;
    }

    .btn:hover {
      background-color: #138d75;
    }

    .btn-secondary {
      background-color: #2980b9;
    }

    .btn-secondary:hover {
      background-color: #216a94;
    }

    .container {
      max-width: 1000px;
      margin: 0 auto;
    }

    .formulaire {
      background: #fff;
      border-radius: 12px;
      padding: 1.5rem;
      margin: 1rem 2rem;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      display: none;
    }

    .formulaire.active {
      display: block;
    }

    .formulaire h3 {
      color: #16a085;
      margin-bottom: 1rem;
    }

    .formulaire form {
      display: grid;
      gap: 1rem;
    }

    .formulaire label {
      font-weight: bold;
      color: #333;
    }

    .formulaire input,
    .formulaire select {
      padding: 0.75rem;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 1rem;
    }

    .formulaire input:focus,
    .formulaire select:focus {
      outline: none;
      border-color: #16a085;
      box-shadow: 0 0 0 2px rgba(22, 160, 133, 0.2);
    }

    .table-stats {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
    }

    .table-stats th, .table-stats td {
      border: 1px solid #ccc;
      padding: 0.75rem;
      text-align: left;
    }

    .table-stats th {
      background-color: #16a085;
      color: white;
    }

    .table-stats tbody tr:nth-child(even) {
      background-color: #f9f9f9;
    }

    .vaccins-section {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 2rem;
      margin: 2rem;
    }

    .vaccin-table-container {
      background: #fff;
      border-radius: 12px;
      padding: 1.5rem;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }

    .vaccin-table-container h3 {
      color: #16a085;
      margin-bottom: 1rem;
      text-align: center;
    }

    footer {
      text-align: center;
      margin: 2rem 0;
    }

    @media (max-width: 900px) {
      .vaccins-section {
        grid-template-columns: 1fr;
      }
    }

    @media (max-width: 600px) {
      .card {
        padding: 1rem;
      }
      .grid-cards {
        padding: 1rem;
      }
      .formulaire {
        margin: 1rem;
      }
      .vaccins-section {
        margin: 1rem;
      }
    }
  </style>
  <script>
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("service-worker.js")
        .then(() => console.log("‚úÖ SW actif"))
        .catch(err => console.error("‚ùå SW error:", err));
    }
  </script>
</head>
<body>
  <header class="top-bar">
    <img src="images/logo.png" alt="FlowLab Logo" class="logo" />
    <h1>FlowLab</h1>
    <h2>Espace M√©dical ‚Äì Suivi et enregistrement</h2>
  </header>

  <main class="container">
    <section class="grid-cards">
      <div class="card" style="background-image: url('images/enfants.png')">
        <h3>üë∂ Enfants</h3>
        <p>Ajoutez un enfant dans le syst√®me avec ses informations.</p>
        <button class="btn" onclick="afficherFormulaire('form-enfant')">Enregistrer un enfant</button>
      </div>

      <div class="card" style="background-image: url('images/grossesses.png')">
        <h3>ü§∞ Grossesses</h3>
        <p>Inscrivez une femme enceinte pour le suivi pr√©natal.</p>
        <button class="btn btn-secondary" onclick="afficherFormulaire('form-grossesse')">Enregistrer une grossesse</button>
      </div>

      <div class="card" style="background-image: url('images/vaccination-ville.webp')">
        <h3>üìÖ Vaccins aujourd'hui</h3>
        <p>Consultez la liste des enfants √† vacciner ou d√©j√† vaccin√©s aujourd'hui.</p>
        <button class="btn" onclick="afficherVaccins()">üìå Voir les vaccinations</button>
      </div>
    </section>

    <!-- Formulaire Enfant --><!-- Formulaire Enfant -->
<section class="formulaire" id="form-enfant">
  <h3>üë∂ Formulaire Enfant</h3>
  <form id="form-enfant-form">
    <label for="nom_complet">Nom complet</label>
    <input id="nom_complet" name="nom_complet" type="text" required placeholder="Nom complet de l'enfant" />

    <label for="date_naissance">Date de naissance</label>
    <input id="date_naissance" name="date_naissance" type="date" required />

    <label for="sexe">Sexe</label>
    <select id="sexe" name="sexe" required>
      <option value="">S√©lectionner</option>
      <option value="M">Masculin</option>
      <option value="F">F√©minin</option>
    </select>

    <label for="telephone_parent">T√©l√©phone du parent</label>
    <input id="telephone_parent" name="telephone_parent" type="tel" required />

    <label for="centre_sante">Structure de sant√©</label>
    <input id="centre_sante" name="centre_sante" type="text" required />

    <label for="province">Province</label>
    <input id="province" name="province" type="text" required />

    <label for="langue_preferee">Langue pr√©f√©r√©e</label>
    <select id="langue_preferee" name="langue_preferee" required>
      <option value="">Langue pr√©f√©r√©e</option>
      <option value="Fran√ßais">Fran√ßais</option>
      <option value="Lingala">Lingala</option>
      <option value="Swahili">Swahili</option>
      <option value="Kikongo">Kikongo</option>
      <option value="Tshiluba">Tshiluba</option>
    </select>

    <button type="submit" class="btn">üìÖ Envoyer</button>
  </form>
  <button type="button" onclick="retourAccueil()" class="btn btn-secondary">‚¨Ö Retour</button>
</section>

    <!-- Formulaire Grossesse -->
   <!-- Formulaire Grossesse -->
<section class="formulaire" id="form-grossesse">
  <h3>ü§∞ Formulaire Grossesse</h3>
  <form id="form-grossesse-form">
    <label for="nom_grossesse">Nom complet</label>
    <input id="nom_grossesse" name="nom" type="text" required />

    <label for="telephone">T√©l√©phone</label>
    <input id="telephone" name="telephone" type="tel" required />

    <label for="semaines_grossesse">Semaines de grossesse</label>
    <input id="semaines_grossesse" name="semaines_grossesse" type="number" min="1" required />

    <label for="dpa">Date pr√©vue d‚Äôaccouchement (DPA)</label>
    <input id="dpa" name="dpa" type="date" required />

    <label for="centre_sante_grossesse">Structure de sant√©</label>
    <input id="centre_sante_grossesse" name="centre_sante" type="text" required />

    <label for="province_grossesse">Province</label>
    <input id="province_grossesse" name="province" type="text" required />

    <label for="langue_preferee_grossesse">Langue pr√©f√©r√©e</label>
    <select id="langue_preferee_grossesse" name="langue_preferee" required>
      <option value="">Langue pr√©f√©r√©e</option>
      <option value="Fran√ßais">Fran√ßais</option>
      <option value="Lingala">Lingala</option>
      <option value="Swahili">Swahili</option>
      <option value="Kikongo">Kikongo</option>
      <option value="Tshiluba">Tshiluba</option>
    </select>

    <button type="submit" class="btn btn-secondary">üìÖ Envoyer</button>
  </form>
  <button type="button" onclick="retourAccueil()" class="btn btn-secondary">‚¨Ö Retour</button>
</section>


    <!-- Section Vaccins -->
    <section class="vaccins-section" id="vaccins-section" style="display: none;">
      <div class="vaccin-table-container">
        <h3>üìå Vaccins √† faire aujourd'hui</h3>
        <table class="table-stats">
          <thead>
            <tr><th>Cat√©gorie</th><th>ID</th><th>Centre Sant√©</th><th>Nom</th><th>Date naissance</th><th>Date RDV</th><th>Vaccin</th><th>Dose</th><th>Action</th></tr>
          </thead>
          <tbody id="table-vaccins-prevus">
            <tr><td>Jean Mukamba</td><td>15/03/2023</td><td>BCG</td><td>1√®re dose</td></tr>
            <tr><td>Marie Nsimba</td><td>28/02/2023</td><td>DTC</td><td>2√®me dose</td></tr>
            <tr><td>Pierre Kabamba</td><td>10/04/2023</td><td>Polio</td><td>1√®re dose</td></tr>
            <tr><td>Grace Mbuyi</td><td>05/01/2023</td><td>Rougeole</td><td>1√®re dose</td></tr>
          </tbody>
        </table>
      </div>

      <div class="vaccin-table-container">
        <h3>‚úÖ Vaccins d√©j√† administr√©s</h3>
        <table class="table-stats">
          <thead>
            <tr><th>Nom</th><th>Date</th><th>Vaccin</th><th>Dose</th></tr>
          </thead>
          <tbody id="table-vaccins-administres">
            <tr><td>Joseph Kilolo</td><td>12/11/2024</td><td>BCG</td><td>1√®re dose</td></tr>
            <tr><td>Sarah Mwamba</td><td>12/11/2024</td><td>DTC</td><td>3√®me dose</td></tr>
            <tr><td>Daniel Kasongo</td><td>11/11/2024</td><td>Polio</td><td>2√®me dose</td></tr>
            <tr><td>Esther Ngandu</td><td>11/11/2024</td><td>Pneumocoque</td><td>1√®re dose</td></tr>
          </tbody>
        </table>
      </div>
      <div style="grid-column: 1/-1; text-align: center; margin-top: 1rem;">
        <button type="button" onclick="retourAccueil()" class="btn btn-secondary">‚¨Ö Retour</button>
      </div>
    </section>

    <footer>
      <a href="index.html" class="btn">‚¨Ö Retour √† l'accueil</a>
    </footer>
  </main>

  <script>
    function afficherFormulaire(id) {
      document.querySelectorAll('.formulaire').forEach(f => f.classList.remove('active'));
      document.getElementById('vaccins-section').style.display = 'none';
      document.querySelector('.grid-cards').style.display = 'none';
      document.getElementById(id).classList.add('active');
    }

    function afficherVaccins() {
      document.querySelectorAll('.formulaire').forEach(f => f.classList.remove('active'));
      document.querySelector('.grid-cards').style.display = 'none';
      document.getElementById('vaccins-section').style.display = 'grid';
    }

    function retourAccueil() {
      document.querySelectorAll('.formulaire').forEach(f => f.classList.remove('active'));
      document.getElementById('vaccins-section').style.display = 'none';
      document.querySelector('.grid-cards').style.display = 'grid';
    }

    // Gestion des formulaires
    document.getElementById('form-enfant-form').addEventListener('submit', function(e) {
      e.preventDefault();
      const formData = new FormData(this);
      const data = Object.fromEntries(formData);
      
      fetch("https://n8n-automation-server-waz-production.up.railway.app/webhook-test/register-child", {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
      })
      .then(response => response.json())
      .then(data => {
        alert(`Enfant ${data.nom_complet} enregistr√© avec succ√®s!`);
        this.reset();
        retourAccueil();
      })
      .catch(error => {
        console.error('Erreur:', error);
        alert('Erreur lors de l\'enregistrement');
      });
    });

    document.getElementById('form-grossesse-form').addEventListener('submit', function(e) {
      e.preventDefault();
      const formData = new FormData(this);
      const data = Object.fromEntries(formData);
      
      fetch('https://n8n-automation-server-waz-production.up.railway.app/webhook-test/register-pregnancy', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
      })
      .then(response => response.json())
      .then(data => {
        alert('Grossesse enregistr√©e avec succ√®s!');
        this.reset();
        retourAccueil();
      })
      .catch(error => {
        console.error('Erreur:', error);
        alert('Erreur lors de l\'enregistrement');
      });
    });

 // ===================================== Vaccins ==========================================   

    // Chargement des donn√©es de vaccination
    fetch("https://n8n-automation-server-waz-production.up.railway.app/webhook-test/vaccinprevue")
      .then(r => r.json())
      .then(data => {
        const rows = (Array.isArray(data) ? data : [data]).map(v => `
        <tr 
          data-categorie="${v.categorie ?? ''}"
          data-personne_id="${v.personne_id ?? ''}"
          data-centre_sante="${v.centre_sante ?? ''}"
          data-nom="${v.nom ?? ''}"
          data-date_naissance="${v.date_naissance ?? ''}"
          data-date_rdv="${v.date_rdv ?? ''}"
          data-vaccin="${v.vaccin ?? ''}"
          data-dose="${v.dose ?? ''}"
        >
          <td>${v.categorie ?? ''}</td>
          <td>${v.personne_id ?? ''}</td>
          <td>${v.centre_sante ?? ''}</td>
          <td>${v.nom ?? ''}</td>
          <td>${v.date_naissance ?? ''}</td>
          <td>${v.date_rdv ?? ''}</td>
          <td>${v.vaccin ?? ''}</td>
          <td>${v.dose ?? ''}</td>
          <td>
            <button class="btn btn-small btn-inline" onclick="confirmerVaccin(this)">
              ‚úÖ Valider
            </button>
          </td>
        </tr>
      `).join("");
      document.getElementById("table-vaccins-prevus").innerHTML = rows;
      })
      .catch(() => {
        console.log("Utilisation des donn√©es par d√©faut pour vaccins pr√©vus");
      });

      const ACTION_URL = "https://n8n-automation-server-waz-production.up.railway.app/webhook-test/vaccinadministrebouton";

      async function confirmerVaccin(buttonEl) {
    const tr = buttonEl.closest('tr');
    // On construit le payload √† partir des data-* du <tr>
    const payload = {
      categorie:      tr.dataset.categorie,
      personne_id:    tr.dataset.personne_id,
      centre_sante:   tr.dataset.centre_sante,
      nom:            tr.dataset.nom,
      date_naissance: tr.dataset.date_naissance,
      date_rdv:       tr.dataset.date_rdv,
      vaccin:         tr.dataset.vaccin,
      dose:           tr.dataset.dose
    };

    // UI: d√©sactiver le bouton pendant l‚Äôenvoi
    const originalText = buttonEl.textContent;
    buttonEl.textContent = "Envoi‚Ä¶";
    buttonEl.disabled = true;

    try {
      const res = await fetch(ACTION_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });
  

      // Tente de lire le JSON (si le serveur renvoie autre chose, √ßa peut throw)
      const resultText = await res.text();
      let result;
      try { result = JSON.parse(resultText); } catch { result = { ok: res.ok, raw: resultText }; }

      if (!res.ok) {
        throw new Error(`HTTP ${res.status} ‚Äì ${resultText?.slice?.(0,200) || 'Erreur serveur'}`);
      }

      // (Optionnel) D√©placer la ligne vers ‚ÄúVaccins d√©j√† administr√©s‚Äù
      // En r√©utilisant nom, date (on met date_rdv √† d√©faut), vaccin, dose
      const adminTbody = document.getElementById("table-vaccins-administres");
      const newRow = document.createElement("tr");
      newRow.innerHTML = `
        <td>${payload.nom || ''}</td>
        <td>${(result?.date_administration) || payload.date_rdv || ''}</td>
        <td>${payload.vaccin || ''}</td>
        <td>${payload.dose || ''}</td>
      `;
      adminTbody.prepend(newRow); // On le met en haut de la liste

      // Retirer la ligne des ‚Äú√† faire‚Äù
      tr.remove();

      alert(`Vaccination confirm√©e pour ${payload.nom || 'patient'} ‚úÖ`);
    } catch (err) {
      console.error("Erreur validation vaccin:", err);
      alert("√âchec de l'envoi : " + err.message);
      // R√©activer le bouton
      buttonEl.disabled = false;
      buttonEl.textContent = originalText;
      return;
    }
  }

  //  ------------- Vaccin Deja Administr√©s ----------------

    fetch("https://n8n-automation-server-waz-production.up.railway.app/webhook-test/vaccinsadministres")
      .then(r => r.json())
      .then(data => {
        const rows = data.map(v => `<tr><td>${v.nom_complet}</td><td>${v.date_administration}</td><td>${v.vaccin}</td><td>${v.dose}</td></tr>`).join("");
        document.getElementById("table-vaccins-administres").innerHTML = rows;
      })
      .catch(() => {
        console.log("Utilisation des donn√©es par d√©faut pour vaccins administr√©s");
      });
  </script>
</body>
</html>

