const BASE_URL = 'https://votre-app.up.railway.app/webhook-test';

const form = document.getElementById('form-enfant');
if (form) {
  form.addEventListener('submit', function (e) {
    e.preventDefault();
    const data = Object.fromEntries(new FormData(form).entries());

    // Génération ID unique type C123456
    data.id_unique = "C" + Math.floor(100000 + Math.random() * 900000);

    if (estEnLigne()) {
      // Vérifier si doublon avant enregistrement
      fetch(`${BASE_URL}/check-doublon`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          nom: data.nom,
          date_naissance: data.date_naissance,
          telephone_parent: data.telephone_parent,
          structure_sante: data.structure_sante
        })
      })
      .then(res => res.json())
      .then(rep => {
        if (rep.doublon === true) {
          afficherMessage('message-form', '⚠️ Cet enfant est déjà enregistré dans cette structure de santé.', 'warning');
        } else {
          // Enregistrement réel
          fetch(`${BASE_URL}/register-child`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          })
          .then(() => {
            afficherMessage('message-form', '✅ Enregistrement réussi', 'success');
            form.reset();
          })
          .catch(() => {
            afficherMessage('message-form', '❌ Erreur réseau. Réessayez.', 'error');
          });
        }
      });
    } else {
      // Enregistrer offline si pas connecté
      const enfantsOffline = JSON.parse(localStorage.getItem('enfants_offline') || '[]');
      enfantsOffline.push(data);
      localStorage.setItem('enfants_offline', JSON.stringify(enfantsOffline));
      afficherMessage('message-form', '❌ Mode hors-ligne – données sauvegardées', 'error');
      form.reset();
    }
  });
}






